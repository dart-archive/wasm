// Copyright (c) 2021, the Dart project authors.  Please see the AUTHORS file
// for details. All rights reserved. Use of this source code is governed by a
// BSD-style license that can be found in the LICENSE file.

// Test that we can load a wasm module, find a function, and call it.
import 'dart:io';
import 'dart:typed_data';

import 'package:test/test.dart';
import 'package:wasm/wasm.dart';

void main() {
  // int32_t foo = 37;
  // extern const int32_t bar;
  // int32_t baz() { return foo * bar; }
  var data = Uint8List.fromList([
    0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x01, 0x05, 0x01, 0x60, //
    0x00, 0x01, 0x7f, 0x02, 0x0c, 0x01, 0x03, 0x65, 0x6e, 0x76, 0x03, 0x62,
    0x61, 0x72, 0x03, 0x7f, 0x00, 0x03, 0x02, 0x01, 0x00, 0x04, 0x04, 0x01,
    0x70, 0x00, 0x00, 0x05, 0x03, 0x01, 0x00, 0x01, 0x06, 0x06, 0x01, 0x7f,
    0x01, 0x41, 0x25, 0x0b, 0x07, 0x16, 0x03, 0x06, 0x6d, 0x65, 0x6d, 0x6f,
    0x72, 0x79, 0x02, 0x00, 0x03, 0x62, 0x61, 0x7a, 0x00, 0x00, 0x03, 0x66,
    0x6f, 0x6f, 0x03, 0x01, 0x0a, 0x09, 0x01, 0x07, 0x00, 0x23, 0x01, 0x23,
    0x00, 0x6c, 0x0b, 0x0b, 0x0a, 0x01, 0x00, 0x41, 0x0c, 0x0b, 0x04, 0x25,
    0x00, 0x00, 0x00,
  ]);

  final mod = WasmModule(data);
  print(mod.describe());
  final builder = mod.builder();
  final bar = builder.addGlobal('env', 'bar', 10);
  final inst = builder.build();
  final foo = inst.lookupGlobal('foo')!;
  final baz = inst.lookupFunction('baz');
  print(foo);
  print(bar);
  print(baz());
  print(foo.value);
  print(bar.value);
  foo.value = 99;
  print(foo.value);
  print(baz());
  bar.value = 100;
}
